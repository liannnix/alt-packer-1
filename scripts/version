#! /bin/sh
set -euo pipefail

target=${target:-alt-server}
arch=${arch:-x86_64}
BASE_VERSION=${BASE_VERSION:-9}
TARGET_VERSION=${TARGET_VERSION:-9}
VM_TYPE=${VM_TYPE:-qemu}
VERSION_FILE=${VERSION_FILE:-scripts/build/image-version}
GIT_TAG=${GIT_TAG:-tag}
GIT_HASH=${GIT_HASH:-hash}
BUILD_DATE=${BUILD_DATE:-date}

GIT_HASH=$(git rev-parse HEAD)
GIT_TAG=$(git tag --points-at HEAD)
BUILD_DATE=$(LC_ALL=POSIX date)

rm -rf ${VERSION_FILE}

echo "Image generated by ALT Packer toolkit" >> ${VERSION_FILE}
echo "Github: https://github.com/altlinuxteam/alt-packer" >> ${VERSION_FILE}
echo "" >> ${VERSION_FILE}
echo "Name: ${target}-${BASE_VERSION}-${VM_TYPE}-${arch}" >> ${VERSION_FILE}
echo "Git hash: ${GIT_HASH}" >> ${VERSION_FILE}
echo "Git tag: ${GIT_TAG}" >> ${VERSION_FILE}
echo "Date: ${BUILD_DATE}" >> ${VERSION_FILE}
